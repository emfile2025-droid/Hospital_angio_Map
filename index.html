<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Angio Status Map</title>
    
    <meta name="theme-color" content="#5d4e46">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">

    <style>
        /* Base Variables */
        :root { 
            --bg-floor: #5d4e46; 
            --status-ready: #4caf50; 
            --status-busy: #e53935; 
            --primary-color: #005088; 
            --nav-height: 60px; 
            --header-height: 50px; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header */
        header { background-color: #fff; padding: 0 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; height: var(--header-height); flex-shrink: 0; z-index: 20; padding-top: env(safe-area-inset-top); }
        .header-left h1 { margin: 0; font-size: 1rem; color: var(--primary-color); }
        .header-right { display: flex; gap: 10px; align-items: center; font-size: 0.8rem; }
        #clock { font-family: monospace; font-weight: bold; font-size: clamp(0.7rem, 2.5vw, 1rem); white-space: nowrap; }
        #connection-status { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; }
        .online { background: #4caf50 !important; box-shadow: 0 0 5px #4caf50; }
        button.sm-btn { background: #fff; border: 1px solid #ccc; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; }
        button.admin-btn { background: #333; color: #fff; border: none; }
        
        /* Main Content */
        .main-content { flex: 1; position: relative; overflow: hidden; background: #f0f2f5; }
        .view-section { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow-y: auto; padding: 10px; padding-bottom: calc(var(--nav-height) + 20px); display: none; }
        .view-section.active { display: block; }

        /* Map Layout */
        .map-container { height: 100%; width: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .floor-map-grid {
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 2vmin; 
            background-color: var(--bg-floor); padding: 2vmin; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative; width: min(96vw, 130vh); height: min(75vh, 72vw); aspect-ratio: 4 / 3; margin: auto;
        }
        .room-card { 
            background: #cce4eb; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            display: flex; flex-direction: column; overflow: hidden; position: relative; 
            user-select: none; cursor: pointer; touch-action: manipulation; transition: transform 0.1s;
        }
        .room-card:active { transform: scale(0.98); }
        .read-only .room-card { cursor: default; transform: none; opacity: 0.9; }

        .pos-top-left { grid-column: 1 / 2; grid-row: 1 / 2; }
        .pos-bottom-left { grid-column: 1 / 2; grid-row: 2 / 3; }
        .pos-bottom-right { grid-column: 2 / 3; grid-row: 2 / 3; }
        .pos-top-right-info { grid-column: 2 / 3; grid-row: 1 / 2; background: #fff; border: 2px solid #005088; }

        .room-header { padding: 1vmin; font-size: clamp(0.8rem, 2vmin, 1.5rem); font-weight: bold; text-align: center; background: rgba(255,255,255,0.4); border-bottom: 1px solid rgba(0,0,0,0.05); color: #333; }
        .chat-widget-header { background: #eef; color: #446; border-bottom: 1px solid #dde; font-size: clamp(0.8rem, 1.8vmin, 1.2rem); }
        .room-status-indicator { flex: 1; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; font-weight: bold; font-size: clamp(1.2rem, 4vmin, 3rem); text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .latest-chat-content { flex: 1; display: flex; flex-direction: column; justify-content: flex-start; align-items: flex-start; text-align: left; padding: 8px; overflow-y: auto; width: 100%; font-size: clamp(0.8rem, 2vmin, 1.1rem); color: #333; line-height: 1.4; word-break: break-word; }
        .latest-chat-content::-webkit-scrollbar { width: 4px; }
        .latest-chat-content::-webkit-scrollbar-track { background: transparent; }
        .latest-chat-content::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }
        .latest-chat-meta { font-size: 0.75em; color: #888; align-self: flex-end; margin-top: auto; padding-top: 4px; }
        .status-ready { background-color: var(--status-ready); } 
        .status-busy { background-color: var(--status-busy); }
        .room-footer { padding: 0.5vmin; font-size: clamp(0.6rem, 1.5vmin, 1rem); background: #fff; color: #555; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Lists & Chat */
        .timeline-item { background: #fff; padding: 10px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #ccc; box-shadow: 0 1px 2px rgba(0,0,0,0.05); font-size: 0.85rem; }
        .timeline-item.log-ready { border-left-color: var(--status-ready); } .timeline-item.log-busy { border-left-color: var(--status-busy); }
        .time-badge { font-size: 0.7rem; color: #999; display: block; margin-bottom: 2px; }
        .chat-footer { position: fixed; bottom: var(--nav-height); left: 0; width: 100%; background: #fff; padding: 10px; border-top: 1px solid #ddd; display: flex; gap: 8px; z-index: 15; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        .chat-footer input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .chat-footer button { background: var(--primary-color); color: white; border: none; padding: 0 15px; border-radius: 4px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height); background: #fff; border-top: 1px solid #ddd; display: flex; justify-content: space-around; align-items: center; z-index: 20; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; color: #888; font-size: 0.7rem; padding: 5px 0; display: flex; flex-direction: column; align-items: center; gap: 4px; cursor: pointer; }
        .nav-item.active { color: var(--primary-color); font-weight: bold; }
        .nav-icon { font-size: 1.2rem; display: block; margin-bottom: 2px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal { background: #fff; padding: 25px; border-radius: 12px; width: 85%; max-width: 400px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal h3 { margin-top: 0; color: var(--primary-color); text-align: center;}
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.85rem; }
        .input-group select, .input-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        button.primary-btn { background-color: var(--primary-color); color: white; border: none; padding: 12px; border-radius: 6px; width: 100%; font-size: 1rem; font-weight: bold; }
        .hidden { display: none !important; }
        table.admin-table { width: 100%; font-size: 0.8rem; border-collapse: collapse; }
        table.admin-table th, td { border: 1px solid #eee; padding: 5px; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>

<header>
    <div class="header-left"><h1>Angio Status <span id="connection-status"></span></h1></div>
    <div class="header-right">
        <div id="clock">--/-- --:--</div>
        <div id="user-display" style="max-width: 80px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">Guest</div>
        <button id="logout-btn" class="sm-btn hidden" onclick="appLogic.logout()">Exit</button>
        <button class="sm-btn admin-btn" onclick="appLogic.openAdmin()">Ad</button>
    </div>
</header>

<div class="main-content" id="main-content-area">
    <div id="view-map" class="view-section active">
        <div class="map-container">
            <div class="floor-map-grid">
                
                <div class="room-card pos-top-left" onclick="appLogic.toggleRoom(2)">
                    <div class="room-header">14-19 è¡€ç®¡æ’®å½±å®¤2</div>
                    <div class="room-status-indicator" id="room-2-status">Sync</div>
                    <div class="room-footer" id="room-2-footer">--</div>
                </div>

                <div class="room-card pos-top-right-info" onclick="appLogic.switchView('chat', document.querySelectorAll('.nav-item')[2])">
                    <div class="room-header chat-widget-header">æœ€æ–°Chat</div>
                    <div id="latest-chat-display" class="latest-chat-content">
                        <span style="color:#ccc; align-self:center;">(ãªã—)</span>
                    </div>
                </div>

                <div class="room-card pos-bottom-left" onclick="appLogic.toggleRoom(3)">
                    <div class="room-header">14-18 å¿ƒè‡“è¡€ç®¡</div>
                    <div class="room-status-indicator" id="room-3-status">Sync</div>
                    <div class="room-footer" id="room-3-footer">--</div>
                </div>

                <div class="room-card pos-bottom-right" onclick="appLogic.toggleRoom(1)">
                    <div class="room-header">14-17 è¡€ç®¡æ’®å½±å®¤1</div>
                    <div class="room-status-indicator" id="room-1-status">Sync</div>
                    <div class="room-footer" id="room-1-footer">--</div>
                </div>

            </div>
        </div>
    </div>

    <div id="view-timeline" class="view-section">
        <h3 style="margin-top:0; color:#666; border-bottom:1px solid #ddd; padding-bottom:5px;">å±¥æ­´ (History)</h3>
        <div id="timeline-list"><div style="text-align:center; padding:20px; color:#999;">æ¥ç¶šä¸­...</div></div>
    </div>
    
    <div id="view-chat" class="view-section" style="padding-bottom: 120px;">
        <h3 style="margin-top:0; color:#666; border-bottom:1px solid #ddd; padding-bottom:5px;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ (Chat)</h3>
        <div id="message-list"><div style="text-align:center; padding:20px; color:#999;">æ¥ç¶šä¸­...</div></div>
        <div class="chat-footer" id="chat-input-area">
             <select id="msg-target-room" style="width: 80px;"><option value="All">All</option><option value="Rm1">Rm1</option><option value="Rm2">Rm2</option><option value="Cardio">å¿ƒè‡“</option></select>
            <input type="text" id="msg-text" placeholder="é€ä¿¡å†…å®¹...">
            <button onclick="appLogic.postMessage()">é€</button>
        </div>
        <div class="chat-footer hidden" id="chat-readonly-msg" style="justify-content:center; color:#999; font-size:0.8rem;">â€»å‚ç…§å°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ã®ãŸã‚æŠ•ç¨¿ã§ãã¾ã›ã‚“</div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="appLogic.switchView('map', this)"><span class="nav-icon">ğŸ—ºï¸</span><span>ãƒãƒƒãƒ—</span></div>
    <div class="nav-item" onclick="appLogic.switchView('timeline', this)"><span class="nav-icon">ğŸ•’</span><span>å±¥æ­´</span></div>
    <div class="nav-item" onclick="appLogic.switchView('chat', this)"><span class="nav-icon">ğŸ’¬</span><span>ãƒãƒ£ãƒƒãƒˆ</span></div>
</div>

<div id="name-modal" class="modal-overlay">
    <div class="modal">
        <h3>ãƒ­ã‚°ã‚¤ãƒ³</h3>
        <div class="input-group">
            <label>å½¹å‰² (Role)</label>
            <select id="input-role" onchange="appLogic.onRoleChange()">
                <option value="å¾ªç’°å™¨ç§‘/è„³å’ä¸­">å¾ªç’°å™¨ç§‘/è„³å’ä¸­</option>
                <option value="æ”¾å°„ç·šæŠ€è¡“ç§‘">æ”¾å°„ç·šæŠ€è¡“ç§‘</option>
                <option value="ç®¡ç†è€…">ç®¡ç†è€… (Admin)</option>
                <option value="å‚ç…§è€…">å‚ç…§è€… (Viewer)</option>
            </select>
        </div>
        <div id="name-input-container">
            <div class="input-group" id="history-group" style="display:none;">
                <label>å±¥æ­´ã‹ã‚‰é¸æŠ</label><select id="history-select" onchange="appLogic.onHistorySelect()"><option value="">-- æ–°ã—ã„åå‰ã‚’å…¥åŠ› --</option></select>
            </div>
            <div class="input-group"><label>æ°å (Name)</label><input type="text" id="input-name" placeholder="æ°åã‚’å…¥åŠ›"></div>
        </div>
        <button class="primary-btn" id="start-btn" onclick="appLogic.registerUser()">é–‹å§‹</button>
    </div>
</div>

<div id="admin-modal" class="modal-overlay">
    <div class="modal" style="max-width:600px;">
        <div style="display:flex; justify-content:space-between; align-items:center;"><h3>ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</h3><button class="sm-btn" onclick="document.getElementById('admin-modal').style.display='none'">é–‰ã˜ã‚‹</button></div>
        <p>æœ¬æ—¥ã®ä½¿ç”¨å›æ•°</p><div id="daily-stats" style="display:flex; gap:10px; margin-bottom:15px; justify-content:space-around;"></div>
        <div style="max-height: 200px; overflow-y: auto;">
            <table class="admin-table"><thead><tr><th>æ™‚é–“</th><th>éƒ¨å±‹</th><th>St</th><th>User</th></tr></thead><tbody id="admin-log-table"></tbody></table>
        </div>
    </div>
</div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW Fail:', err)); });
    }

    const firebaseConfig = {
      apiKey: "AIzaSyAuIftnSDzCcZu7KCJQwsbXLqy6WJDca60",
      authDomain: "angioroomshare.firebaseapp.com",
      projectId: "angioroomshare",
      storageBucket: "angioroomshare.firebasestorage.app",
      messagingSenderId: "643422156272",
      appId: "1:643422156272:web:4a877ceec68c444c72d935",
      measurementId: "G-EWKRWV6LYR"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    const USER_KEY = "angio_sys_user_v3";
    const HISTORY_KEY = "angio_user_history";
    let currentUser = { name: null, role: null };
    let globalLogs = []; let globalRooms = {};

    const appLogic = {
        init: function() {
            this.loadUser(); this.initAuth();
            setInterval(this.updateClock, 1000); this.updateClock();
            window.addEventListener('resize', () => { document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`); });
        },
        initAuth: function() {
            const statusEl = document.getElementById('connection-status');
            auth.signInAnonymously().catch(e => { console.error(e); statusEl.classList.add('error'); });
            auth.onAuthStateChanged(u => { if(u){this.initListeners();}else{statusEl.classList.remove('online');} });
        },
        initListeners: function() {
            db.ref(".info/connected").on("value", s => {
                const el = document.getElementById('connection-status');
                if(s.val()) el.classList.add('online'); else el.classList.remove('online');
            });
            db.ref('rooms').on('value', s => { globalRooms = s.val() || {}; this.renderMap(globalRooms); });
            db.ref('logs').limitToLast(50).on('value', s => {
                const arr = [];
                if (s.exists()) { s.forEach(c => { const val = c.val(); if (val && val.timestamp) { arr.unshift(val); } }); }
                globalLogs = arr; this.renderTimeline(arr);
            });
            db.ref('messages').limitToLast(20).on('value', s => {
                const arr = [];
                if (s.exists()) { s.forEach(c => { const val = c.val(); if (val && val.timestamp) arr.unshift(val); }); }
                this.renderMessages(arr);
            });
        },
        switchView: function(viewId, navEl) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(navEl) navEl.classList.add('active');
        },
        loadUser: function() {
            const saved = localStorage.getItem(USER_KEY);
            if (saved) { currentUser = JSON.parse(saved); this.applyRoleUI(currentUser); } 
            else { this.showLoginModal(); }
        },
        applyRoleUI: function(user) {
            document.getElementById('name-modal').style.display = 'none';
            document.getElementById('user-display').textContent = user.name;
            document.getElementById('logout-btn').classList.remove('hidden');
            
            // UI Logic Update for Ver 5.5.0
            if (user.role === 'å‚ç…§è€…') {
                // Viewer: Status Change DISABLED, Chat DISABLED
                document.getElementById('main-content-area').classList.add('read-only');
                document.getElementById('chat-input-area').classList.add('hidden');
                document.getElementById('chat-readonly-msg').classList.remove('hidden');
            } else if (user.role === 'å¾ªç’°å™¨ç§‘/è„³å’ä¸­') {
                // Cardio/Stroke: Status Change DISABLED, Chat ENABLED
                document.getElementById('main-content-area').classList.add('read-only');
                document.getElementById('chat-input-area').classList.remove('hidden');
                document.getElementById('chat-readonly-msg').classList.add('hidden');
            } else {
                // Radiology/Admin: Everything ENABLED
                document.getElementById('main-content-area').classList.remove('read-only');
                document.getElementById('chat-input-area').classList.remove('hidden');
                document.getElementById('chat-readonly-msg').classList.add('hidden');
            }
        },
        showLoginModal: function() {
            document.getElementById('logout-btn').classList.add('hidden');
            document.getElementById('name-modal').style.display = 'flex';
            this.onRoleChange(); 
        },
        onRoleChange: function() {
            const role = document.getElementById('input-role').value;
            const cnt = document.getElementById('name-input-container');
            const btn = document.getElementById('start-btn');
            
            if (role === 'å‚ç…§è€…') {
                // Viewer: Hide Name Input, Change Button Text
                cnt.style.display = 'none'; 
                btn.textContent = "é–²è¦§ã‚’é–‹å§‹";
            } else {
                // Others: Show Name Input, Standard Button Text
                cnt.style.display = 'block'; 
                btn.textContent = "é–‹å§‹";
                
                const h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '{}');
                const n = h[role] || [];
                const grp = document.getElementById('history-group');
                const sel = document.getElementById('history-select');
                if (n.length > 0) {
                    grp.style.display = 'block'; sel.innerHTML = '<option value="">-- å±¥æ­´ã‹ã‚‰é¸æŠ --</option>';
                    n.forEach(v => { const o = document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
                } else { grp.style.display = 'none'; }
                document.getElementById('input-name').value = '';
            }
        },
        onHistorySelect: function() {
            const v = document.getElementById('history-select').value;
            if(v) document.getElementById('input-name').value = v;
        },
        registerUser: function() {
            const role = document.getElementById('input-role').value;
            let name = document.getElementById('input-name').value.trim();
            if (role === 'ç®¡ç†è€…') {
                const id = prompt("ç®¡ç†è€…ID"); if(id!=='185383') return alert("NG");
                const pw = prompt("ç®¡ç†è€…PW"); if(pw!=='angio') return alert("NG");
            }
            
            if (role === 'å‚ç…§è€…') {
                name = 'Guest Viewer'; // No input required
            } else {
                if (!name) return alert("æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                const h = JSON.parse(localStorage.getItem(HISTORY_KEY) || '{}');
                if (!h[role]) h[role] = [];
                if (!h[role].includes(name)) { h[role].unshift(name); h[role] = h[role].slice(0,5); localStorage.setItem(HISTORY_KEY, JSON.stringify(h)); }
            }
            
            currentUser = { name, role };
            localStorage.setItem(USER_KEY, JSON.stringify(currentUser));
            this.applyRoleUI(currentUser);
        },
        logout: function() { if(confirm('é€€å‡º?')){localStorage.removeItem(USER_KEY); location.reload();} },
        toggleRoom: function(id) {
            if (!currentUser.name) return this.showLoginModal();
            // Logic Update: Disabled for Viewer & Cardio/Stroke
            if (currentUser.role === 'å‚ç…§è€…' || currentUser.role === 'å¾ªç’°å™¨ç§‘/è„³å’ä¸­') return;
            
            const r = globalRooms[id] || { status: 'ready' };
            const n = r.status === 'ready' ? 'busy' : 'ready';
            const ts = Date.now();
            db.ref('rooms/'+id).set({status:n, lastChange:ts, by:currentUser.name, role:currentUser.role});
            db.ref('logs').push({timestamp:ts, type:'status_change', roomId:id, status:n, user:currentUser.name, role:currentUser.role});
        },
        postMessage: function() {
            if (!currentUser.name) return this.showLoginModal();
            // Disabled for Viewer
            if (currentUser.role === 'å‚ç…§è€…') return;

            const t = document.getElementById('msg-text').value.trim();
            if(!t) return;
            db.ref('messages').push({timestamp:Date.now(), text:t, target:document.getElementById('msg-target-room').value, user:currentUser.name, role:currentUser.role});
            document.getElementById('msg-text').value = '';
        },
        updateClock: function() { 
            const now = new Date();
            const dateStr = now.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric', weekday: 'short' });
            const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('clock').textContent = `${dateStr} ${timeStr}`; 
        },
        renderMap: function(d) {
            [1,2,3].forEach(id => {
                const r = d[id] || {status:'ready',by:'-'};
                const st = document.getElementById(`room-${id}-status`);
                st.className='room-status-indicator '+(r.status==='ready'?'status-ready':'status-busy');
                st.textContent=r.status==='ready'?'READY':'IN USE';
                document.getElementById(`room-${id}-footer`).textContent=r.lastChange?`${new Date(r.lastChange).toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'})} - ${r.by}`:'--';
            });
        },
        renderTimeline: function(l) {
            const d = document.getElementById('timeline-list'); d.innerHTML='';
            const validLogs = l.filter(v => v && v.timestamp);
            if(validLogs.length === 0) { return d.innerHTML='<div style="text-align:center;color:#ccc;padding:20px">å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>'; }
            validLogs.forEach(v => {
                try {
                    const el = document.createElement('div');
                    el.className = `timeline-item ${v.status==='ready'?'log-ready':'log-busy'}`;
                    const timeStr = new Date(v.timestamp).toLocaleString('ja-JP', {
                        month: 'numeric', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit'
                    });
                    let rName = `Angio ${v.roomId}`;
                    if(v.roomId==1) rName="è¡€ç®¡1"; if(v.roomId==2) rName="è¡€ç®¡2"; if(v.roomId==3) rName="å¿ƒè‡“";
                    el.innerHTML = `<span class="time-badge">${timeStr}</span><strong>${rName}</strong>: ${v.status==='busy'?'é–‹å§‹':'çµ‚äº†'}<br><span style="color:#555">by ${v.user||'Unknown'}</span>`;
                    d.appendChild(el);
                } catch(e) { console.error('Render Error:', e); }
            });
        },
        renderMessages: function(m) {
            const d = document.getElementById('message-list'); d.innerHTML='';
            
            const latestBox = document.getElementById('latest-chat-display');
            if (m.length > 0) {
                const latest = m[0];
                const tStr = new Date(latest.timestamp).toLocaleTimeString('ja-JP', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'});
                latestBox.innerHTML = `
                    <div style="width:100%; display:flex; justify-content:space-between; font-size:0.85em; font-weight:bold; color:#005088; margin-bottom:4px; border-bottom:1px solid #eee; padding-bottom:2px;">
                        <span>${tStr}</span>
                        <span>@${latest.target}</span>
                    </div>
                    <div style="width:100%; margin-bottom:4px;">${latest.text}</div>
                    <div class="latest-chat-meta">by ${latest.user}</div>
                `;
            } else {
                latestBox.innerHTML = '<span style="color:#ccc; align-self:center;">(ãªã—)</span>';
            }

            if(m.length===0) return d.innerHTML='<div style="text-align:center;color:#ccc;padding:20px">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            m.forEach(v => {
                try {
                    const el = document.createElement('div');
                    el.className = 'timeline-item'; el.style.borderLeftColor='#005088';
                    const timeStr = new Date(v.timestamp).toLocaleTimeString('ja-JP', {
                        month: 'numeric', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit'
                    });
                    
                    el.innerHTML = `<span class="time-badge">${timeStr} @${v.target}</span>${v.text}<br><span style="color:#555">by ${v.user}</span>`;
                    d.appendChild(el);
                } catch(e) { console.error(e); }
            });
        },
        openAdmin: function() {
            if(currentUser.role!=='ç®¡ç†è€…'){ const i=prompt("ID"); if(i!=='185383')return; const p=prompt("PW"); if(p!=='angio')return; }
            document.getElementById('admin-modal').style.display='flex'; this.renderAdmin();
        },
        renderAdmin: function() {
            const s = document.getElementById('daily-stats'); s.innerHTML='';
            [1,2,3].forEach(id => {
                const c = globalLogs.filter(l=>l && l.roomId===id && l.status==='busy' && (l.type==='status_change'||!l.type) && l.timestamp && new Date(l.timestamp).toDateString()===new Date().toDateString()).length;
                let rName = `A${id}`; if(id==3) rName="å¿ƒè‡“";
                s.innerHTML+=`<div style="text-align:center;background:#eee;padding:5px;border-radius:4px"><strong>${rName}</strong><br>${c}å›</div>`;
            });
            const tb = document.getElementById('admin-log-table'); tb.innerHTML='';
            globalLogs.filter(l=> (l.type==='status_change'||!l.type) && l.timestamp).forEach(l=>{
                const tr=document.createElement('tr');
                let rName = `Angio ${l.roomId}`; if(l.roomId==1) rName="è¡€ç®¡1"; if(l.roomId==2) rName="è¡€ç®¡2"; if(l.roomId==3) rName="å¿ƒè‡“";
                tr.innerHTML=`<td>${new Date(l.timestamp).toLocaleTimeString('ja-JP')}</td><td>${rName}</td><td>${l.status==='busy'?'èµ¤':'ç·‘'}</td><td>${l.user}</td>`;
                tb.appendChild(tr);
            });
        }
    };
    window.onload = () => appLogic.init();
</script>
</body>
</html>
